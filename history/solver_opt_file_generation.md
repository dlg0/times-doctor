# Solver .opt File Generation Feature

## Overview

Updated the `review-solver-options` and `scan` commands to work together for automated solver configuration testing.

## Changes Made

### 1. Updated Solver Options Review Prompt (`prompts/solver_options_review/v1.txt`)

- Modified LLM to generate **~12 different .opt configurations** instead of general recommendations
- Added structured delimiter format for parsing: `===OPT_FILE: filename.opt` / `===END_OPT_FILE`
- Instructed LLM to use descriptive names (e.g., `tight_tolerances.opt`, `moderate_scaling.opt`)
- Requested systematic parameter variations testing different hypotheses

### 2. Enhanced `review-solver-options` Command (`src/times_doctor/cli.py`)

Added automatic .opt file extraction:
- New `_extract_opt_files()` function to parse LLM response using regex
- Extracts all .opt files from delimited blocks in LLM output
- Writes files to `<run_dir>/_td_opt_files/` directory
- Displays count and suggests running `scan` command next

### 3. Redesigned `scan` Command (`src/times_doctor/cli.py`)

Completely changed from hardcoded profiles to LLM-generated configs:
- **Removed**: Hardcoded `profiles` parameter (dual, sift, bar_nox)
- **Removed**: `opt_lines()` function with hardcoded configurations
- **Added**: Detection of `_td_opt_files/` directory
- **Added**: User confirmation prompt listing all found configurations
- **Added**: Direct copy of .opt files from `_td_opt_files/` to scan run directories
- **Updated**: Documentation to reflect new workflow

### 4. Updated `.gitignore`

Added `_td_opt_files/` to ignore generated solver configurations

## Workflow

### Before (Old Way)
```bash
times-doctor scan data/myrun --profiles dual sift bar_nox
```
- Used 3 hardcoded solver profiles
- No customization based on actual problem

### After (New Way)
```bash
# Step 1: Generate solver configurations based on actual run
times-doctor review-solver-options data/myrun

# Output shows:
# Extracted 12 solver configurations to data/myrun/_td_opt_files/
# Use 'times-doctor scan' to test these configurations

# Step 2: Test all generated configurations
times-doctor scan data/myrun

# Prompts:
# Found 12 solver configurations in _td_opt_files/:
#   1. baseline_tighter
#   2. tight_tolerances
#   3. aggressive_barrier
#   ...
# Run scan with these 12 configurations? [Y/n]
```

## Example LLM Output Format

```markdown
### 2. Generated Solver Configurations

===OPT_FILE: baseline_tighter.opt
epopt 1e-7       $ Slightly tighter than default 1e-6
eprhs 1e-7       $ Match feasibility tolerance to epopt
===END_OPT_FILE

===OPT_FILE: tight_tolerances.opt
epopt 1e-8       $ Very tight optimality tolerance
eprhs 1e-8       $ Very tight feasibility tolerance
barepcomp 1e-10  $ Very tight barrier convergence
===END_OPT_FILE

===OPT_FILE: aggressive_barrier.opt
epopt 1e-9       $ Extremely tight optimality
eprhs 1e-9       $ Extremely tight feasibility
barepcomp 1e-11  $ Extremely tight barrier
baritlim 10000   $ Increase iteration limit
===END_OPT_FILE
```

## Implementation Details

### Parsing Logic
- Uses regex pattern: `r"===OPT_FILE:\s*(\S+\.opt)\s*\n(.*?)===END_OPT_FILE"`
- Flags: `re.DOTALL | re.MULTILINE`
- Returns: `dict[str, str]` mapping filename to content

### File Structure
```
<run_dir>/
├── _td_opt_files/              # Generated by review-solver-options
│   ├── baseline_tighter.opt
│   ├── tight_tolerances.opt
│   ├── aggressive_barrier.opt
│   └── ...
└── times_doctor_out/
    └── scan_runs/              # Generated by scan
        ├── baseline_tighter/
        │   └── cplex.opt       # Copied from _td_opt_files/
        ├── tight_tolerances/
        │   └── cplex.opt
        └── ...
```

## Testing

Verified:
- ✅ Regex parsing extracts multiple .opt files correctly
- ✅ scan command detects _td_opt_files/ directory
- ✅ scan command lists all configurations and prompts user
- ✅ No mypy type errors introduced
- ✅ Help text updated correctly

## Benefits

1. **Context-aware**: Configurations tailored to specific model issues
2. **Systematic**: Tests ~12 variations exploring parameter space
3. **Automated**: No manual .opt file creation needed
4. **Traceable**: All configs saved for future reference
5. **Flexible**: LLM can adapt number and type of configs to problem
